{% extends "base.html" %}

{% block title %}–£—Ä–æ–∫–∏ Dart - IT –ê–∫–∞–¥–µ–º–∏—è{% endblock %}

{% block content %}
<div class="lessons-container">
    <div class="lessons-sidebar">
        <h2>–ö—É—Ä—Å Dart</h2>
        <div class="course-progress-summary">
            <div class="progress-circle">
                <span id="progress-percentage">0%</span>
            </div>
            <p>–ü—Ä–æ–≥—Ä–µ—Å—Å –∫—É—Ä—Å–∞</p>
        </div>
        <div id="lessons-list" class="lessons-list">
            <!-- –°–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
        </div>
        
        {% if progress %}
        <script id="server-progress-data" type="application/json">
            {{ progress|tojson }}
        </script>
        {% endif %}
    </div>

    <div class="lesson-content">
        <div id="lesson-header" class="lesson-header">
            <div class="lesson-meta">
                <span id="lesson-category" class="lesson-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                <span id="lesson-difficulty" class="lesson-difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</span>
                <span id="lesson-progress" class="lesson-progress">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress-text">0%</span></span>
            </div>
            <h1 id="lesson-title">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞</h1>
            <p id="lesson-description">–û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
        </div>

        <div id="lesson-theory" class="lesson-theory" style="display: none;">
            <h3>üìö –¢–µ–æ—Ä–∏—è</h3>
            <div id="theory-content" class="theory-content"></div>
            <button id="show-task" class="theory-button">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–¥–∞–Ω–∏—é ‚Üí</button>
        </div>

        <div id="lesson-task" class="lesson-task" style="display: none;">
            <h3>üéØ –ó–∞–¥–∞–Ω–∏–µ</h3>
            <p id="task-description"></p>
        </div>

        <div id="lesson-workspace" class="lesson-workspace" style="display: none;">
            <div class="code-section">
                <div class="editor-header">
                    <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</h3>
                    <button id="reset-code" class="reset-button">–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–¥</button>
                </div>
                <textarea id="code-editor" placeholder="–ö–æ–¥ —É—Ä–æ–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å..."></textarea>
            </div>

            <div class="output-section">
                <div class="output-header">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
                    <button id="run-code" class="run-button">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥</button>
                </div>
                <div id="code-output" class="output-display">
                    –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å
                </div>
                <div id="hints-section" class="hints-section" style="display: none;">
                    <h4>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏</h4>
                    <ul id="hints-list"></ul>
                    <button id="show-hints" class="hints-button">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</button>
                </div>
            </div>
        </div>

        <div id="lesson-controls" class="lesson-controls" style="display: none;">
            <button id="prev-lesson" class="nav-button">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–∫</button>
            <button id="next-lesson" class="nav-button">–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ ‚Üí</button>
        </div>
    </div>
</div>

<div id="loading" class="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <p>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentLesson = null;
let lessons = [];
let codeEditor;

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∫–æ–¥–∞
    codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: 'dart',
        theme: 'monokai',
        lineNumbers: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentUnit: 2,
        tabSize: 2
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—Ä–æ–∫–æ–≤
    loadLessons();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('run-code').addEventListener('click', function() {
        const code = codeEditor.getValue();
        runDartCode(code, 'code-output');
    });

    document.getElementById('reset-code').addEventListener('click', function() {
        if (currentLesson) {
            codeEditor.setValue(currentLesson.code_template);
        }
    });

    document.getElementById('prev-lesson').addEventListener('click', function() {
        const currentIndex = lessons.findIndex(l => l.id === currentLesson.id);
        if (currentIndex > 0) {
            loadLesson(lessons[currentIndex - 1]);
        }
    });

    document.getElementById('next-lesson').addEventListener('click', function() {
        const currentIndex = lessons.findIndex(l => l.id === currentLesson.id);
        if (currentIndex < lessons.length - 1) {
            loadLesson(lessons[currentIndex + 1]);
        }
    });

    // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –∑–∞–¥–∞–Ω–∏—é
    document.getElementById('show-task').addEventListener('click', function() {
        document.getElementById('lesson-workspace').style.display = 'block';
        document.querySelector('.lesson-workspace').scrollIntoView({ behavior: 'smooth' });
    });

    // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫
    document.getElementById('show-hints').addEventListener('click', function() {
        const hintsList = document.getElementById('hints-list');
        const button = document.getElementById('show-hints');
        
        if (hintsList.style.display === 'none' || hintsList.style.display === '') {
            hintsList.style.display = 'block';
            button.textContent = '–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏';
        } else {
            hintsList.style.display = 'none';
            button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏';
        }
    });
});

function updateProgressDisplay() {
    const progressKey = 'lesson_progress';
    const progress = JSON.parse(localStorage.getItem(progressKey) || '{}');
    
    const totalLessons = lessons.length;
    let completedLessons = 0;
    
    for (let i = 1; i <= totalLessons; i++) {
        if (progress[i] && progress[i].completed) {
            completedLessons++;
        }
    }
    
    const progressPercent = Math.round((completedLessons / totalLessons) * 100);
    document.getElementById('progress-percentage').textContent = progressPercent + '%';
}

async function loadLessons() {
    try {
        const response = await fetch('/api/lessons');
        lessons = await response.json();
        
        const lessonsListEl = document.getElementById('lessons-list');
        lessonsListEl.innerHTML = '';
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —É—Ä–æ–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        const categories = {};
        lessons.forEach(lesson => {
            if (!categories[lesson.category]) {
                categories[lesson.category] = [];
            }
            categories[lesson.category].push(lesson);
        });
        
        // –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        Object.keys(categories).forEach(category => {
            const categoryEl = document.createElement('div');
            categoryEl.className = 'category-section';
            categoryEl.innerHTML = `<h3 class="category-title">${category}</h3>`;
            
            categories[category].forEach(lesson => {
                const lessonEl = document.createElement('div');
                lessonEl.className = 'lesson-item';
                lessonEl.innerHTML = `
                    <div class="lesson-number">${lesson.id}</div>
                    <div class="lesson-info">
                        <h4>${lesson.title}</h4>
                        <p>${lesson.description}</p>
                        <span class="difficulty-badge ${lesson.difficulty.toLowerCase()}">${lesson.difficulty}</span>
                    </div>
                `;
                lessonEl.addEventListener('click', () => loadLesson(lesson));
                categoryEl.appendChild(lessonEl);
            });
            
            lessonsListEl.appendChild(categoryEl);
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (lessons.length > 0) {
            loadLesson(lessons[0]);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–∫–æ–≤:', error);
    }
}

function loadLesson(lesson) {
    currentLesson = lesson;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    document.getElementById('lesson-category').textContent = lesson.category;
    document.getElementById('lesson-difficulty').textContent = lesson.difficulty;
    document.getElementById('lesson-difficulty').className = `lesson-difficulty ${lesson.difficulty.toLowerCase()}`;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
    document.getElementById('lesson-title').textContent = lesson.title;
    document.getElementById('lesson-description').textContent = lesson.description;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–æ—Ä–∏—é
    const theoryEl = document.getElementById('lesson-theory');
    const theoryContent = document.getElementById('theory-content');
    if (lesson.theory) {
        theoryContent.innerHTML = marked.parse(lesson.theory);
        theoryEl.style.display = 'block';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ
    const taskEl = document.getElementById('lesson-task');
    const taskDescription = document.getElementById('task-description');
    if (lesson.task) {
        taskDescription.textContent = lesson.task;
        taskEl.style.display = 'block';
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
    const hintsSection = document.getElementById('hints-section');
    const hintsList = document.getElementById('hints-list');
    if (lesson.hints && lesson.hints.length > 0) {
        hintsList.innerHTML = '';
        lesson.hints.forEach(hint => {
            const li = document.createElement('li');
            li.textContent = hint;
            hintsList.appendChild(li);
        });
        hintsSection.style.display = 'block';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –æ–±–ª–∞—Å—Ç—å –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
    document.getElementById('lesson-workspace').style.display = 'none';
    document.getElementById('lesson-controls').style.display = 'flex';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ —É—Ä–æ–∫–∞
    codeEditor.setValue(lesson.code_template);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —É—Ä–æ–∫ –≤ —Å–ø–∏—Å–∫–µ
    document.querySelectorAll('.lesson-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const lessonItems = document.querySelectorAll('.lesson-item');
    const lessonIndex = lessons.findIndex(l => l.id === lesson.id);
    if (lessonItems[lessonIndex]) {
        lessonItems[lessonIndex].classList.add('active');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    const currentIndex = lessons.findIndex(l => l.id === lesson.id);
    document.getElementById('prev-lesson').disabled = currentIndex === 0;
    document.getElementById('next-lesson').disabled = currentIndex === lessons.length - 1;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    updateProgressDisplay();
}
</script>
{% endblock %}